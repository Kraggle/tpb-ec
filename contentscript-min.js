console.log=function(){};let e,t,i,n,a,s={ep:{},day:{}},c="https://www.ettvdl.com",o="old",d=[],r=[],l=!1,h=0;function p(){$('a[href!=""]').off("click").on("click",(function(e){"https://episodecalendar.com"+$(this).attr("href")!=o&&u(),p()}));const e=".epic-episode-marker-wrapper";$("body").off("click",e).on("click",e,(function(){const e=$(this).closest(".calendar-day");$("input:not(:checked)",e).length?$(".calendar_date",e).removeClass("seen"):$(".calendar_date",e).addClass("seen"),m()}))}function u(){let e=$("body")[0];const n=setInterval((function(){window.location.href!=o&&$("body")[0]==e&&(!function(){o=window.location.href;const e=new Date;if(e.setHours(23,59,59),i=[],$("body").hasClass("calendar")){const e=$("td.month h2").first().text()+"_"+$("p.year").first().text();s.ep[e]||(s.ep[e]=[]),t=s.ep[e],s.day[e]||(s.day[e]=[]),i=s.day[e],$("#page_container .magnetized").length||(t.length=0,$(".episode-item").each((function(e,i){t.push(new V({id:$(this).attr("id"),title:$(this).find(".show").text(),episode:$(this).find(".episode").text().match(/\((S\d+E\d+)\)/)[1],checked:$(this).hasClass("seen"),released:$(this).find("input").length>0}))})),$(".calendar_cell_content").each((function(e,t){const n=new C({id:$(this).attr("id"),released:$("input",this).length>0});0==$("input:not(:checked)",this).length&&n.head().addClass("seen"),i.push(n)})))}else if($("body").hasClass("unwatched")){const i=$(".cached-view:visible").attr("id");s.ep[i]||(s.ep[i]=[]),t=s.ep[i],$(".cached-view:visible .magnetized").length||(t.length=0,$(".cached-view:visible .season").each((function(i,n){const a=$(this).find("h2").find("a").text().match(/(.*) - Season \d/)[1].replace(/[,.-]/,"");$("<div />",{class:"separator"}).appendTo($(".epic-list-episode",this));const s=$("<div />",{class:"magnet-container center"}).appendTo($(".epic-list-episode",this));$("<div />",{class:"grey margin_bottom_mini"}).text("Magnet").appendTo(s),$(".epic-list-episode",this).each((function(){const i=$(this).find(".date").find("strong").text();t.push(new V({id:$(this).attr("id"),title:a,episode:$(this).find(".mid_grey").find("strong").text(),checked:!1,released:new Date(i).getTime()<e.getTime()}))}))})))}else if($("body").hasClass("show")){if(0==$(".description").length){const e={en:"eng",br:"por",de:"deu",dk:"dan",es:"spa",fr:"fra",gr:"eng",it:"ita",nl:"nld",pl:"pol",pt:"por",ro:"eng",rs:"eng",ru:"rus",se:"swe",tu:"tur"}[$("#logo").attr("href").replace("/","")],t=$(".links a:nth-of-type(2)").attr("href").replace(/https{0,1}/,"https");chrome.runtime.sendMessage({url:t},(function(t){$(".page-container.pad_top .col-24").before($("<p />",{class:"description",text:$(`#translations div[data-language=${e}] p:nth-of-type(1)`,t.success).text()}))}))}const i=$(".cached-view:visible").attr("id");if(s.ep[i]||(s.ep[i]=[]),t=s.ep[i],!$(".cached-view:visible .magnetized").length){t.length=0,$("<div />",{class:"separator"}).appendTo($(".cached-view:visible .epic-list-episode"));const i=$("<div />",{class:"magnet-container center"}).appendTo($(".cached-view:visible .epic-list-episode"));$("<div />",{class:"grey margin_bottom_mini"}).text("Magnet").appendTo(i);const n=$(".show_banner").find("h1").text().replace(/[,.-]/,"");$(".cached-view:visible .epic-list-episode").each((function(){const i=$(this).find(".epic-episode-marker"),a=$(this).find(".date").find("strong").text();t.push(new V({id:$(this).attr("id"),title:n,episode:$(this).find(".mid_grey").find("strong").text(),checked:i.length&&i.checked,released:new Date(a).getTime()<e.getTime()}))}))}}if($.each(t,(function(e,t){if(!t.get().hasClass("magnetized")&&t.released){const i=t.get().find(".magnet-container"),n=$("<div />",{class:i.length?"big magnet":"magnet",title:"Download!"}).attr("index",e).appendTo(i.length?i:t.get());n.on("click",k),$("<div />",{class:"loader"}).hide().appendTo(n),t.get().addClass("magnetized")}else t.released||t.get().find(".magnet-container .grey").css("opacity",0)})),$.each(i,(function(e,t){if(!t.get().hasClass("magnetized")&&t.released){$("<div />",{class:"magnet",title:"Download all unwatched from day!"}).attr("index",e).appendTo(t.head()).on("click",g),t.get().addClass("magnetized")}})),!$("#menu").hasClass("magnetized")){const e=$("<li />",{class:"download-all"}).appendTo($("#menu"));$("<a />",{id:"download-btn",href:""}).text("Download all").appendTo(e).on("click",f),$("<span />",{class:"menu-notification",id:"dl-count"}).text("0").appendTo(e),$("#menu").addClass("magnetized")}m(),p()}(),clearInterval(n)),e=$("body")[0]}),1e3)}function f(e){e.preventDefault(),$.each(t,(function(e,t){$("input:not(:checked)",t.get()).length&&k.call($(".magnet",t.get()).get(0))}))}function g(e){let n=i[$(this).attr("index")];$(".magnet",n.get()).each((function(e,i){n=t[$(this).attr("index")],$("input",n.get()).is(":checked")||k.call($(".magnet",n.get()).get(0))}))}function m(){const e=".epic-episode-marker-wrapper input:not(:checked)";setTimeout((function(){$("body").hasClass("calendar")?$("#dl-count").text($(e).length):$("#dl-count").text($(".cached-view:visible "+e).length)}),1e3)}function k(){$(this).off("click"),t[$(this).attr("index")].get().find(".loader").fadeIn("250"),d.push($(this).attr("index")),y.call(t[d[0]].get().find(".magnet"))}function v(e){r.push(e),w()}function y(i){if(l)return;l=!0;const n=$(this),s=t[$(this).attr("index")],o=s.get().find(".loader");chrome.storage.sync.get({quality:1,hevc:!0,check:!0,index:0,clicked:!1},(function(t){let i;e=t,a=e.index,chrome.runtime.sendMessage({url:s.getETTV()},(function(e){e.error?(T(n,o),b()):(i=e.success,"string"==typeof i&&i.bMatch(/<title>Advanced Search | ETTV Torrents | Official<\/title>/i)?d():(T(n,o),b()))}));const d=function(){if(s.download())v(s),e.check&&$("input:not(:checked)",s.get()).click(),T(n,o),b();else{i=i.replace(/(<head.*?>[\s\S]*?<\/head>|<script.*?>[\s\S]*?<\/script>|<style.*?>[\s\S]*?<\/style>)/gi,"").replace(/<(link|img|meta).+?>/gi,"");const e={};$(".table-bordered tr:has(td)",i).each((function(){const t={};$(this).children().each((function(e){1==e?t.href=c+$("a[href]",this).attr("href"):3==e?t.size=function(e){if(e.includes(" MB"))return Math.round(+e.replace(" MB",""));{let t=+e.replace(" GB","");return Math.round(1024*t)}}($(this).text()):5==e&&(t.seed=+$("b",this).text().replace(",",""))})),t.quality=t.href.bMatch(/1080p/i)?"1080":t.href.bMatch(/720p/i)?"720":"Standard",t.hevc=t.href.bMatch(/HEVC|x265/i);const i=`m${t.quality}${t.hevc?"HEVC":""}`;(!e[i]||e[i].seed<t.seed)&&(e[i]=t,s[i]=t.href)})),chrome.runtime.sendMessage({getLink:!0,item:s,type:s.getType()},(function(e){if(e.error)return T(n,o),void b();s[s.getType()]=e.item[s.getType()],s.download()&&v(s),T(n,o),b()}))}}}))}function b(){d.shift(),l=!1,d.length>0&&y.call(t[d[0]].get().find(".magnet"))}function w(){n||(n=!0,window.location=r[0].download(),e.clicked?setTimeout((()=>{x()}),1e3):E().fadeIn(800).on("click",(function(e){$(this).fadeOut(400),setTimeout((()=>{$(this).remove(),x()}),400)})),e.check&&$("input:not(:checked)",r[0].get()).click(),m())}function x(){r.shift(),n=!1,r.length>0&&w()}function T(e,t){e.on("click",k),t.fadeOut("250")}$((()=>{p(),$("<div />",{class:"app-message-box"}).appendTo($("body")),u()}));class V{id;title;episode;checked;released;m1080;m1080HEVC;m720;m720HEVC;mStandard;replaces=[{from:/(!|\'|\(\d+\)|\& )/g,to:""},{from:/the inhumans/i,to:"inhumans"}];constructor(e){for(const t in e)this[t]=e[t]}get(){return $("#"+this.id)}getTitle(){let e=this.title;for(const t of this.replaces)e=e.replace(t.from,t.to);return $.trim(e)}getETTV(){const e=this.getTitle().replace(/ |\./g,"+")+"+"+this.episode;return c+"/torrents-search.php?search="+e}getRegex(){return new RegExp(this.getTitle().replace(/ /g,".+").replace(/S.H.I.E.L.D./,"(S.H.I.E.L.D|SHIELD)")+".+"+this.episode,"i")}download(){const t=e.quality;if(e.hevc){if((2==t||1==t&&!this.m720HEVC)&&this.m1080HEVC)return this.m1080HEVC;if((1==t||2==t)&&this.m720HEVC)return this.m720HEVC}if((2==t||1==t&&!this.m720)&&this.m1080)return this.m1080;if((1==t||2==t)&&this.m720)return this.m720;if(this.mStandard)return this.mStandard;if(0==t){if(e.hevc){if(this.m720HEVC)return this.m720HEVC;if(this.m1080HEVC)return this.m1080HEVC}if(this.m720)return this.m720;if(this.m1080)return this.m1080}}getType(){let t=e.quality;if(e.hevc){if((2==t||1==t&&!this.m720HEVC)&&this.m1080HEVC)return"m1080HEVC";if((1==t||2==t)&&this.m720HEVC)return"m720HEVC"}if((2==t||1==t&&!this.m720)&&this.m1080)return"m1080";if((1==t||2==t)&&this.m720)return"m720";if(this.mStandard)return"mStandard";if(0==t){if(e.hevc){if(this.m720HEVC)return"m720HEVC";if(this.m1080HEVC)return"m1080HEVC"}if(this.m720)return"m720";if(this.m1080)return"m1080"}}}class C{id;released;constructor(e){for(const t in e)this[t]=e[t]}get(){return $("#"+this.id)}head(){return this.get().parent().find(".calendar_date")}}const E=()=>{const t=$("<div />",{class:"app-dialogue",i:h}).appendTo($("body"));let i=$("<div />",{class:"app-dialogue-border"}).appendTo(t);$("<span />",{class:"app-dialogue-click",text:"Click anywhere to continue the queue!"}).appendTo(i),$("<span />",{class:"app-dialogue-sorry",text:"This is necessary since chrome updated the way external applications are selected. Without this you can not download in bulk as the rest of the queue would be ignored."}).appendTo(i),$("<span />",{class:"app-dialogue-click",text:"or..."}).appendTo(i),$("<span />",{class:"app-dialogue-sorry",text:"If you have the latest version of chrome, you can check the 'Always allow episodecalendar.com...' in the popup dialogue, then check this next box to download in bulk again. Thank you chrome developers."}).appendTo(i);let n=$("<label />",{class:"app-dialogue-check",for:"clicked-it"}).appendTo(i),a=$("<input />",{class:"app-dialogue-checkbox",type:"checkbox",id:"clicked-it"}).prop("checked",e.clicked).appendTo(n);return $("<span />",{class:"app-dialogue-text",text:"I've selected 'Always allow episodecalendar.com to open links...'"}).appendTo(n),$("<div />",{class:"app-dialogue-back mark"}).appendTo(n),$("<div />",{class:"app-dialogue-tick mark"}).appendTo(n),n.on("click",(function(t){t.stopPropagation(),e.clicked=a.is(":checked"),chrome.storage.sync.set({quality:e.quality,hevc:e.hevc,check:e.check,clicked:e.clicked})})),h++,t};!function(e){function t(t,i){if(t){let t=this.data("attr-old-value");if(i.attributeName.indexOf("style")>=0){t.style||(t.style={});let n=i.attributeName.split(".");i.attributeName=n[0],i.oldValue=t.style[n[1]],i.newValue=n[1]+":"+this.prop("style")[e.camelCase(n[1])],t.style[n[1]]=i.newValue}else i.oldValue=t[i.attributeName],i.newValue=this.attr(i.attributeName),t[i.attributeName]=i.newValue;this.data("attr-old-value",t)}}let i=window.MutationObserver||window.WebKitMutationObserver;e.fn.attrchange=function(n,a){if("object"==typeof n){let a={trackValues:!1,callback:e.noop};if("function"==typeof n?a.callback=n:e.extend(a,n),a.trackValues&&this.each((function(t,i){let n={};for(let e,t=0,a=i.attributes,s=a.length;t<s;t++)e=a.item(t),n[e.nodeName]=e.value;e(this).data("attr-old-value",n)})),i){let t={subtree:!1,attributes:!0,attributeOldValue:a.trackValues},n=new i((function(t){t.forEach((function(t){let i=t.target;a.trackValues&&(t.newValue=e(i).attr(t.attributeName)),void 0===e(this).data("attrchange-tdisconnect")&&a.callback.call(i,t)}))}));return this.data("attrchange-method","Mutation Observer").data("attrchange-obs",n).each((function(){n.observe(this,t)}))}return function(){let e=document.createElement("p"),t=!1;if(e.addEventListener)e.addEventListener("DOMAttrModified",(function(){t=!0}),!1);else{if(!e.attachEvent)return!1;e.attachEvent("onDOMAttrModified",(function(){t=!0}))}return e.setAttribute("id","target"),t}()?this.data("attrchange-method","DOMAttrModified").on("DOMAttrModified",(function(t){t.originalEvent&&(t=t.originalEvent),t.attributeName=t.attrName,t.oldValue=t.prevValue,void 0===e(this).data("attrchange-tdisconnect")&&a.callback.call(this,t)})):"onpropertychange"in document.body?this.data("attrchange-method","propertychange").on("propertychange",(function(i){i.attributeName=window.event.propertyName,t.call(e(this),a.trackValues,i),void 0===e(this).data("attrchange-tdisconnect")&&a.callback.call(this,i)})):this}if("string"==typeof n&&e.fn.attrchange.hasOwnProperty("extensions")&&e.fn.attrchange.extensions.hasOwnProperty(n))return e.fn.attrchange.extensions[n].call(this,a)}}(jQuery),String.prototype.bMatch||(String.prototype.bMatch=function(e){return null!==this.toString().match(e)});